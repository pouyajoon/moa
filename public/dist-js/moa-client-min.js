function startup(){$("#map_canvas").height($(window).height()),$("#mainScreen").fadeOut(),new Game(function(a,b){console.log("game loaded"),b.emitSocket("gameLoaded",{})})}function isInside(a,b){return a.x<=0?!1:a.y<=0?!1:a.x>=b.x?!1:a.y>=b.y?!1:!0}function createActionNodesDisplay(){var a=$("#setActions");$.each(actionNodesItems,function(b,c){a.append('<li id="setAction_'+c.name+'" class="setAction" name="'+c.name+'">'+c.name+"</li>");var d=$("#setAction_"+c.name);d.data("name",c.name),d.data("color",c.color)})}function initActionNodes(){createActionNodesDisplay(),$(".setAction").click(function(a){var b=$(this).attr("name");game.setAction=b,$(".setAction").css("background-color","white"),$(this).css("background-color",$(this).data("color"))})}function zoomOutFromZone(){nodeserver.emit("stopzone"),$("#mainScreen").fadeOut(),$("#navigationRight").fadeOut(),$("#map_canvas").fadeIn(500),map!==null&&(google.maps.event.trigger(map,"resize"),map.setZoom(map.getZoom()))}function createTopNavigation(){$("#buttonSubscibe").click(function(){game.currentZone!==null&&nodeserver.emit("createQueen",game.currentZone)})}function getAntInfo(a){var b=a.data("antInfo"),c="Name : "+b.name+"<br/>";c+="Position : ["+b.position.x+","+b.position.y+"]<br/>"+"Draw Position : ["+b.drawPosition.x+", "+b.drawPosition.y+"]"}function drawStaticElements(a,b){$.each(b.localStatics,function(b,c){var d=c.w/camera.worldZoomLevel,e=c.h/camera.worldZoomLevel;c.type=="colony"&&a.drawImage(imgHome,c.dX,c.dY,d,e)})}function drawActionNodes(a,b){$.each(b,function(b,c){var d=c.data.size.w/camera.worldZoomLevel,e=c.data.size.h/camera.worldZoomLevel;if(isInDrawScreen(c.data.position)){var f=(c.data.position.x-camera.translateX)/camera.ScreenSize.w*camera.worldInitX,g=(c.data.position.y-camera.translateY)/camera.ScreenSize.h*camera.worldInitY;a.fillStyle=$("#setAction_"+c.data.type).data("color"),a.fillRect(f,g,d,e)}})}function drawBigMap(a,b){a.fillStyle="rgb(0,255,0)",a.canvas.width=camera.miniMapSize,a.canvas.height=camera.miniMapSize,a.clearRect(0,0,camera.miniMapSize,camera.miniMapSize),$.each(b,function(b,c){var d=c.data.size.w/camera.worldMaxSize.x*camera.miniMapSize,e=c.data.size.h/camera.worldMaxSize.y*camera.miniMapSize,f=c.data.position.x/camera.worldMaxSize.x*camera.miniMapSize,g=c.data.position.y/camera.worldMaxSize.y*camera.miniMapSize;a.fillRect(f,g,d,e)})}function isInDrawScreen(a,b){var c=a.x>=b.translateX&&a.x<=b.ScreenSize.w+b.translateX,d=a.y>=b.translateY&&a.y<=b.ScreenSize.h+b.translateY;return c&&d}function drawAnts(a,b){a.fillStyle="rgb(60,60,60)",$.each(b,function(b,c){var d=c.data,e=d.size.w/camera.worldZoomLevel,f=d.size.h/camera.worldZoomLevel,g=imgAIdle;d.action=="move"&&(g=imgAMove),d.action=="digg"&&(g=imgADigg),isInDrawScreen(d.position)&&(a.save(),a.translate(d.position.x+d.size.w/2,d.position.y+d.size.h/2),a.rotate(d.angle*Math.PI/180),a.drawImage(g,-d.size.w/2,-d.size.h/2,d.size.w,d.size.h),a.restore())})}function WorldMap(a){function c(a){this.setMap(this.map)}this.ID="map_canvas",this.mapOptions=new WorldMapOptions,this.map=new google.maps.Map(document.getElementById(this.ID),this.mapOptions);var b=new ZonesMapType(new google.maps.Size(256,256));this.map.overlayMapTypes.insertAt(0,b),c.prototype=new google.maps.OverlayView,c.prototype.onAdd=function(){},c.prototype.onRemove=function(){},c.prototype.draw=function(){};var d=new c(this.map);new WorldMapGeocoder(this.map);var e=!0;google.maps.event.addListener(this.map,"click",function(a){if(this.map.getZoom()!=21)return;var b=this.mouseClickToTileCoordinate(a.qa),c=this.mouseClickToCoordinateInTile(a.qa),d=this.tileCoordinateToMiddleLatLng(b);this.onClickInMap(a,b,c)}.bind(this)),google.maps.event.addListener(this.map,"idle",function(b){if(e)return e=!1,a(this)}.bind(this))}function setIntervalX(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&(b/=2,window.clearInterval(e))},b)}function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,b){return rstr2any(rstr_md5(str2rstr_utf8(a)),b)}function hex_hmac_md5(a,b){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_md5(a,b){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_md5(a,b,c){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),a.length*8))}function rstr_hmac_md5(a,b){var c=rstr2binl(a);c.length>16&&(c=binl_md5(c,a.length*8));var d=Array(16),e=Array(16);for(var f=0;f<16;f++)d[f]=c[f]^909522486,e[f]=c[f]^1549556828;var g=binl_md5(d.concat(rstr2binl(b)),512+b.length*8);return binl2rstr(binl_md5(e.concat(g),640))}function rstr2hex(a){try{_.isUndefined(hexcase)}catch(b){hexcase=0}var c=hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",e;for(var f=0;f<a.length;f++)e=a.charCodeAt(f),d+=c.charAt(e>>>4&15)+c.charAt(e&15);return d}function rstr2b64(a){try{_.isUndefined(hexcase)}catch(b){b64pad=""}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d="",e=a.length;for(var f=0;f<e;f+=3){var g=a.charCodeAt(f)<<16|(f+1<e?a.charCodeAt(f+1)<<8:0)|(f+2<e?a.charCodeAt(f+2):0);for(var h=0;h<4;h++)f*8+h*6>a.length*8?d+=b64pad:d+=c.charAt(g>>>6*(3-h)&63)}return d}function rstr2any(a,b){var c=b.length,d,e,f,g,h,i=Array(Math.ceil(a.length/2));for(d=0;d<i.length;d++)i[d]=a.charCodeAt(d*2)<<8|a.charCodeAt(d*2+1);var j=Math.ceil(a.length*8/(Math.log(b.length)/Math.log(2))),k=Array(j);for(e=0;e<j;e++){h=[],g=0;for(d=0;d<i.length;d++){g=(g<<16)+i[d],f=Math.floor(g/c),g-=f*c;if(h.length>0||f>0)h[h.length]=f}k[e]=g,i=h}var l="";for(d=k.length-1;d>=0;d--)l+=b.charAt(k[d]);return l}function str2rstr_utf8(a){var b="",c=-1,d,e;while(++c<a.length)d=a.charCodeAt(c),e=c+1<a.length?a.charCodeAt(c+1):0,55296<=d&&d<=56319&&56320<=e&&e<=57343&&(d=65536+((d&1023)<<10)+(e&1023),c++),d<=127?b+=String.fromCharCode(d):d<=2047?b+=String.fromCharCode(192|d>>>6&31,128|d&63):d<=65535?b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63):d<=2097151&&(b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&63));return b}function str2rstr_utf16le(a){var b="";for(var c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)&255,a.charCodeAt(c)>>>8&255);return b}function str2rstr_utf16be(a){var b="";for(var c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)>>>8&255,a.charCodeAt(c)&255);return b}function rstr2binl(a){var b=Array(a.length>>2);for(var c=0;c<b.length;c++)b[c]=0;for(var d=0;d<a.length*8;d+=8)b[d>>5]|=(a.charCodeAt(d/8)&255)<<d%32;return b}function binl2rstr(a){var b="";for(var c=0;c<a.length*32;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}function binl_md5(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;var c=1732584193,d=-271733879,e=-1732584194,f=271733878;for(var g=0;g<a.length;g+=16){var h=c,i=d,j=e,k=f;c=md5_ff(c,d,e,f,a[g+0],7,-680876936),f=md5_ff(f,c,d,e,a[g+1],12,-389564586),e=md5_ff(e,f,c,d,a[g+2],17,606105819),d=md5_ff(d,e,f,c,a[g+3],22,-1044525330),c=md5_ff(c,d,e,f,a[g+4],7,-176418897),f=md5_ff(f,c,d,e,a[g+5],12,1200080426),e=md5_ff(e,f,c,d,a[g+6],17,-1473231341),d=md5_ff(d,e,f,c,a[g+7],22,-45705983),c=md5_ff(c,d,e,f,a[g+8],7,1770035416),f=md5_ff(f,c,d,e,a[g+9],12,-1958414417),e=md5_ff(e,f,c,d,a[g+10],17,-42063),d=md5_ff(d,e,f,c,a[g+11],22,-1990404162),c=md5_ff(c,d,e,f,a[g+12],7,1804603682),f=md5_ff(f,c,d,e,a[g+13],12,-40341101),e=md5_ff(e,f,c,d,a[g+14],17,-1502002290),d=md5_ff(d,e,f,c,a[g+15],22,1236535329),c=md5_gg(c,d,e,f,a[g+1],5,-165796510),f=md5_gg(f,c,d,e,a[g+6],9,-1069501632),e=md5_gg(e,f,c,d,a[g+11],14,643717713),d=md5_gg(d,e,f,c,a[g+0],20,-373897302),c=md5_gg(c,d,e,f,a[g+5],5,-701558691),f=md5_gg(f,c,d,e,a[g+10],9,38016083),e=md5_gg(e,f,c,d,a[g+15],14,-660478335),d=md5_gg(d,e,f,c,a[g+4],20,-405537848),c=md5_gg(c,d,e,f,a[g+9],5,568446438),f=md5_gg(f,c,d,e,a[g+14],9,-1019803690),e=md5_gg(e,f,c,d,a[g+3],14,-187363961),d=md5_gg(d,e,f,c,a[g+8],20,1163531501),c=md5_gg(c,d,e,f,a[g+13],5,-1444681467),f=md5_gg(f,c,d,e,a[g+2],9,-51403784),e=md5_gg(e,f,c,d,a[g+7],14,1735328473),d=md5_gg(d,e,f,c,a[g+12],20,-1926607734),c=md5_hh(c,d,e,f,a[g+5],4,-378558),f=md5_hh(f,c,d,e,a[g+8],11,-2022574463),e=md5_hh(e,f,c,d,a[g+11],16,1839030562),d=md5_hh(d,e,f,c,a[g+14],23,-35309556),c=md5_hh(c,d,e,f,a[g+1],4,-1530992060),f=md5_hh(f,c,d,e,a[g+4],11,1272893353),e=md5_hh(e,f,c,d,a[g+7],16,-155497632),d=md5_hh(d,e,f,c,a[g+10],23,-1094730640),c=md5_hh(c,d,e,f,a[g+13],4,681279174),f=md5_hh(f,c,d,e,a[g+0],11,-358537222),e=md5_hh(e,f,c,d,a[g+3],16,-722521979),d=md5_hh(d,e,f,c,a[g+6],23,76029189),c=md5_hh(c,d,e,f,a[g+9],4,-640364487),f=md5_hh(f,c,d,e,a[g+12],11,-421815835),e=md5_hh(e,f,c,d,a[g+15],16,530742520),d=md5_hh(d,e,f,c,a[g+2],23,-995338651),c=md5_ii(c,d,e,f,a[g+0],6,-198630844),f=md5_ii(f,c,d,e,a[g+7],10,1126891415),e=md5_ii(e,f,c,d,a[g+14],15,-1416354905),d=md5_ii(d,e,f,c,a[g+5],21,-57434055),c=md5_ii(c,d,e,f,a[g+12],6,1700485571),f=md5_ii(f,c,d,e,a[g+3],10,-1894986606),e=md5_ii(e,f,c,d,a[g+10],15,-1051523),d=md5_ii(d,e,f,c,a[g+1],21,-2054922799),c=md5_ii(c,d,e,f,a[g+8],6,1873313359),f=md5_ii(f,c,d,e,a[g+15],10,-30611744),e=md5_ii(e,f,c,d,a[g+6],15,-1560198380),d=md5_ii(d,e,f,c,a[g+13],21,1309151649),c=md5_ii(c,d,e,f,a[g+4],6,-145523070),f=md5_ii(f,c,d,e,a[g+11],10,-1120210379),e=md5_ii(e,f,c,d,a[g+2],15,718787259),d=md5_ii(d,e,f,c,a[g+9],21,-343485551),c=safe_add(c,h),d=safe_add(d,i),e=safe_add(e,j),f=safe_add(f,k)}return Array(c,d,e,f)}function md5_cmn(a,b,c,d,e,f){return safe_add(bit_rol(safe_add(safe_add(b,a),safe_add(d,f)),e),c)}function md5_ff(a,b,c,d,e,f,g){return md5_cmn(b&c|~b&d,a,b,e,f,g)}function md5_gg(a,b,c,d,e,f,g){return md5_cmn(b&d|c&~d,a,b,e,f,g)}function md5_hh(a,b,c,d,e,f,g){return md5_cmn(b^c^d,a,b,e,f,g)}function md5_ii(a,b,c,d,e,f,g){return md5_cmn(c^(b|~d),a,b,e,f,g)}function safe_add(a,b){var c=(a&65535)+(b&65535),d=(a>>16)+(b>>16)+(c>>16);return d<<16|c&65535}function bit_rol(a,b){return a<<b|a>>>32-b}function getMarkerQueen(){var a=new google.maps.Marker({draggable:!1,raiseOnDrag:!1,icon:imageQueen,shadow:imageQueenShadow,shape:shapeQueen,map:map,position:ruetaine});return google.maps.event.addListener(a,"click",function(){var a=new google.maps.LatLngBounds;a.extend(this.getPosition()),zoomIn(21,this.getPosition()),map.panToBounds(a);var b=this}),a}function ZonesMapType(a){this.tileSize=a}var AntInfoBox=function(a,b){this.remove(),this.antMessage=b;var c=a.socket,d=[];d.push('<div class="antInfoBox"><ul>'),this.pushAttribute(d,"User",b.user.email),this.pushAttribute(d,"Action",b.ant.action),_.each(b.actions,function(a){switch(a){case"sendToInventory":this.pushAction(d,"Send To Inventory",a);break;case"move":break;default:}}.bind(this)),d.push("</ul></div>"),$("body").append(d.join("")),_.each(b.actions,function(a){switch(a){case"sendToInventory":$("#"+this.getActionID(a)).click(function(a){c.emit("sendToInventory",this.antMessage.ant._id)}.bind(this));break;case"move":break;default:}}.bind(this))};AntInfoBox.prototype.getActionID=function(a){return this.antMessage.ant._id+"-"+a},AntInfoBox.prototype.remove=function(){$(".antInfoBox").remove()},AntInfoBox.prototype.pushAttribute=function(a,b,c){a.push("<li>",b,":",c,"</li>")},AntInfoBox.prototype.pushAction=function(a,b,c){a.push('<li><a href="#" id="',this.getActionID(c),'">',b,"</a></li>")},$(function(){startup()});var SocketManager=function(a,b){this.game=a,this.serverURL=b,this.socket=io.connect(this.serverURL),this.socket.on("connect",function(a){console.log("connected")}),this.socket.on("disconnect",function(a){console.log("disconnected"),this.game.close()}.bind(this))};SocketManager.prototype.emit=function(a,b,c){if(this.socket===null)return;console.log("emit ",a,b),this.socket.emit(a,b,c)},SocketManager.prototype.on=function(a,b){if(this.socket===null)return;this.socket.on(a,b)},SocketManager.prototype.unbind=function(a){if(this.socket===null)return;this.socket.removeAllListeners(a)};var Inventory=function(a){this.game=a,this.game.bindOnSocket("inventory",this.loadInventoryFromSocket.bind(this))};Inventory.prototype.loadInventoryFromSocket=function(a){console.log("inventory",a),$("#inventory #inventory-content").html(""),this.antsByID={},_.each(a.ants,function(a){this.antsByID[a._id]=a,$("#inventory #inventory-content").append('<div class="ant" id="'+a._id+'"></div>'),this.disableAntsDraggable()}.bind(this))},Inventory.prototype.close=function(){this.game.unbindOnSocket("inventory")},Inventory.prototype.disableAntsDraggable=function(){$("#inventory .ant").draggable("destroy"),$("#inventory .ant").addClass("disable")},Inventory.prototype.enableAntsDraggable=function(a){$("#inventory .ant").removeClass("disable"),this.startAntsDraggable(a)},Inventory.prototype.startAntsDraggable=function(a){var b=a.camera;$("#inventory .ant").hover(function(){console.log("hover",$(this).data("drag")),$(this).data("drag")||$(this).css("cursor","pointer")}),$("#inventory .ant").each(function(c,d){var e=$(d).attr("id"),f=this.antsByID[e];$(d).bind("mousewheel",function(a,c){return b.mouseWheel(a,c),!1}.bind(this));var g=null;$(d).data("drag",!1),$(d).draggable({start:function(a){$("#mainScreen").css("cursor","none"),$(this).css("cursor","none");var b=$(d).offset();g={x:a.pageX-b.left,y:a.pageY-b.top}},drag:function(a){b.mouseMove(a),$(this).css("cursor","none"),$(d).data("drag",!0),$(d).css("margin-left",g.x+"px"),$(d).css("margin-top",g.y+"px");var c=f.size.w,e=f.size.h;isInside(b.mouseInDrawZone,b.drawZoneSize)&&(c=1/b.scale*f.size.w,e=1/b.scale*f.size.h),$(d).width(c).height(e)}.bind(this),stop:function(c){$("#mainScreen").css("cursor","default"),$(d).data("drag",!1),$(d).css("cursor","default"),isInside(b.mouseInDrawZone,b.drawZoneSize)?($(d).draggable("destroy"),this.game.emitSocket("moveAntFromInventoryToZone",{zoneID:a.getZoneID(),antID:e,position:b.mouseInDrawZone},function(a){console.log("moved",a)})):($(d).css("margin-left","0px"),$(d).css("margin-top","0px"),$(d).css("left","0px").css("top","0px"),$(d).width(f.size.w).height(f.size.h))}.bind(this)})}.bind(this))},Inventory.prototype.draw=function(){$("body").append('<div id="inventory"><div class="inventory-title">Inventory</div><div id="inventory-content"></div></div>')};var actionNodesItems=[{name:"none",color:"grey"},{name:"follow",color:"green"},{name:"digg",color:"red"},{name:"idle",color:"cyan"},{name:"move",color:"yellow"}],drawMap=!0,Game=function(a){this.currentGameCanvas=null,this.socketManager=new SocketManager(this,MOA_SERVER),this.inventory=new Inventory(this),this.inventory.draw(),new WorldMap(function(b){return console.log("world map created"),this.worldMap=b,this.worldMap.onClickInMap=this.onClickInMap.bind(this),a(null,this)}.bind(this))};Game.prototype.emitSocket=function(a,b,c){this.socketManager.emit(a,b,c)},Game.prototype.bindOnSocket=function(a,b){this.socketManager.on(a,b)},Game.prototype.unbindOnSocket=function(a){this.socketManager.unbind(a)},Game.prototype.showGameCanvas=function(a,b,c){console.log(this.gameCanvas);var d=b.x+"_"+b.y;this.currentGameCanvas=new GameCanvas(this,b),this.currentGameCanvas.camera.initialTranslate.set(a.pixel.x-c.x,a.pixel.y-c.y),this.currentGameCanvas.camera.translate.copy(this.currentGameCanvas.camera.initialTranslate),this.currentGameCanvas.show(500),this.socketManager.emit("getZone",b.x+"_"+b.y),this.inventory.enableAntsDraggable(this.currentGameCanvas)},Game.prototype.hideGameCanvas=function(){this.worldMap.show(250,this.currentGameCanvas.tileCoordinate),this.currentGameCanvas.close(250);var a=this.currentGameCanvas.getZoneID();this.socketManager.emit("stopzone",a),this.inventory.disableAntsDraggable(),this.currentGameCanvas=null},Game.prototype.onClickInMap=function(a,b,c){this.showGameCanvas(a,b,c)};var imgAMove=new Image;imgAMove.src="/images/ant.gif";var imgADigg=new Image;imgADigg.src="/images/aDigg.gif";var imgAIdle=new Image;imgAIdle.src="/images/aIdle.gif";var imgTree=new Image;imgTree.src="/images/tree.gif";var imgHome=new Image;imgHome.src="/images/home.gif";var game={currentZone:null,numberOfAnts:0,setAction:"none"},GameCanvas=function(a,b){console.log("new game canvas"),this.game=a,this.tileCoordinate=b,this.backgroundSize=512;var c=this.game.worldMap.getImageURLFromTileCoordinate(this.tileCoordinate),d=c+"&size="+this.backgroundSize+"x"+this.backgroundSize+"&scale=2";this.backgroundImage=new Image,this.backgroundImage.src=d,$("#mainScreen").click(function(){}.bind(this)),this.ants=[],this.game.bindOnSocket("zone",function(a){this.ants=a.ants}.bind(this)),this.game.bindOnSocket("ant",function(a){console.log("antMessage",a),a.err&&console.log(a.err),new AntInfoBox(this.game.socketManager,a)}.bind(this)),this.canvasID="mainScreen",this.canvas=document.getElementById(this.canvasID),this.ctx=this.canvas.getContext("2d"),this.ctx.canvas.width=$(this.canvas).width(),this.ctx.canvas.height=$(this.canvas).height(),this.drawZoneSize={w:4096,h:4096},this.camera=new CanvasCamera(this.canvas,this.drawZoneSize),this.camera.scaleMax=this.drawZoneSize.w/TILE_SIZE,this.camera.scale=this.camera.scaleMax,this.camera.scaleFactor=.25,this.camera.scaleNum=1,this.camera.initialTranslate.set(this.canvas.width/2-TILE_SIZE/2,this.canvas.height/2-TILE_SIZE/2),this.camera.translate.copy(this.camera.initialTranslate),this.selectedAnt=null,$(this.camera.canvas).click(function(a){this.camera.mouseMove(a),this.selectedAnt=this.clickedOnAnt(),this.selectedAnt!==null?this.game.emitSocket("getAnt",this.selectedAnt._id):$(".antInfoBox").remove()}.bind(this)),this.camera.scaleIsMoreThanScaleMax=function(a){if(a.translate.equals(a.initialTranslate,10))return a.translate=a.initialTranslate,this.game.hideGameCanvas(),!1;var b=a.translate.getSubPoint(a.initialTranslate);return b.div(3),a.translate.sub(b),!0}.bind(this),this.tickInterval=setInterval(function(){this.tick()}.bind(this),1e3/12)};GameCanvas.prototype.clickedOnAnt=function(){var a=null;return _.each(this.ants,function(b){if(this.camera.mouseInDrawZone.isInside(b.position,b.size))return a=b,!1}.bind(this)),a},GameCanvas.prototype.getZoneID=function(){return this.tileCoordinate.x+"_"+this.tileCoordinate.y},GameCanvas.prototype.close=function(a){clearInterval(this.tickInterval),this.camera.close(),this.game.unbindOnSocket("zone"),this.game.unbindOnSocket("ant"),this.hide(a)},GameCanvas.prototype.hide=function(a){$("#mainScreen").fadeOut(a)},GameCanvas.prototype.show=function(a){$("#mainScreen").fadeIn(a)},GameCanvas.prototype.tick=function(){this.camera.update(),this.camera.debug(),this.camera.clearContext(this.ctx),this.ctx.save(),this.camera.transform(this.ctx);var a=new Point;a.set(this.drawZoneSize.w/2,this.drawZoneSize.h/2),this.ctx.drawImage(this.backgroundImage,-a.x,-a.y,this.drawZoneSize.w*2,this.drawZoneSize.h*2),this.ctx.strokeStyle="#000",this.ctx.strokeRect(0,0,this.drawZoneSize.w,this.drawZoneSize.h),this.drawAnts(),this.ctx.restore()},GameCanvas.prototype.drawAnts=function(){this.ctx.fillStyle="rgb(60,60,60)",_.each(this.ants,function(a){var b=imgAIdle;a.action=="move"&&(b=imgAMove),this.ctx.save(),this.ctx.translate(a.position.x+a.size.w/2,a.position.y+a.size.h/2),this.ctx.rotate(a.angle*Math.PI/180),this.ctx.drawImage(b,-a.size.w/2,-a.size.h/2,a.size.w,a.size.h),this.selectedAnt!==null&&this.selectedAnt._id==a._id&&(this.ctx.strokeStyle="rgb(0, 0, 0)",this.ctx.beginPath(),this.ctx.arc(0,0,50,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.closePath()),this.ctx.restore()}.bind(this))};var MiniMap=function(a){this.parent=$("#"+a),this.create()};MiniMap.prototype.create=function(){var a=[];a.push('<canvas id="gameMiniMap"></canvas>'),this.parent.append(a.join(""))},MiniMap.prototype.hide=function(){$("#gameMiniMap").fadeOut(500)},MiniMap.prototype.setBackgroundImage=function(a){$("#gameMiniMap").css("background-image",'url("'+a+'")')};var TILE_SIZE=256,ruetaine=new google.maps.LatLng(48.837890444364774,2.392113855719572),rueTaineTile={x:1062511,y:721645};WorldMap.prototype.onClickInMap=function(a,b,c){},WorldMap.prototype.hide=function(a){$("#"+this.ID).fadeOut(a)},WorldMap.prototype.show=function(a,b){$("#"+this.ID).fadeIn(a)},WorldMap.prototype.getImageURLFromTileCoordinate=function(a){var b=this.tileCoordinateToMiddleLatLng(a);return this.mapOptions.getMapImageURL(b)},WorldMap.prototype.tileCoordinateToLatLng=function(a){var b=1<<this.map.getZoom(),c=new google.maps.Point(a.x*TILE_SIZE,a.y*TILE_SIZE),d=new google.maps.Point(c.x/b,c.y/b),e=this.map.getProjection(),f=e.fromPointToLatLng(d);return f},WorldMap.prototype.mouseClickToCoordinateInTile=function(a){var b=1<<this.map.getZoom(),c=a,d=new google.maps.Point(c.x*b,c.y*b),e=new google.maps.Point(Math.floor(d.x%TILE_SIZE),Math.floor(d.y%TILE_SIZE));return e},WorldMap.prototype.mouseClickToTileCoordinate=function(a){var b=1<<this.map.getZoom(),c=a,d=new google.maps.Point(c.x*b,c.y*b),e=new google.maps.Point(Math.floor(d.x/TILE_SIZE),Math.floor(d.y/TILE_SIZE));return e},WorldMap.prototype.tileCoordinateToMiddleLatLng=function(a){var b=this.tileCoordinateToLatLng(a),c=this.tileCoordinateToLatLng({x:a.x+1,y:a.y+1}),d=new google.maps.LatLng(b.lat()+(c.lat()-b.lat())/2,b.lng()+(c.lng()-b.lng())/2);return d};var WorldMapGeocoder=function(a){this.map=a;var b=new google.maps.Geocoder;$("#searchbox").autocomplete({source:function(a,c){b===null&&(b=new google.maps.Geocoder),b.geocode({address:a.term},function(a,d){if(d==google.maps.GeocoderStatus.OK){var e=a[0].geometry.location,f=a[0].geometry.location.lat(),g=a[0].geometry.location.lng(),h=new google.maps.LatLng(f,g),i=a[0].geometry.bounds;b.geocode({latLng:h},function(a,b){b==google.maps.GeocoderStatus.OK&&a[1]&&c($.map(a,function(a){return{label:a.formatted_address,value:a.formatted_address,bounds:a.geometry.bounds}}))})}})},select:function(a,b){var c=b.item.position,d=b.item.locType,e=b.item.bounds;e&&this.map.fitBounds(e)}.bind(this)})},WorldMapOptions=function(){this.mapStyle=[{featureType:"landscape.man_made",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{hue:"#0044ff"}]},{featureType:"landscape.natural",stylers:[{gamma:.5},{hue:"#00ff3c"},{saturation:53},{lightness:-33}]},{featureType:"poi.park",stylers:[{hue:"#00ff44"},{lightness:-40}]},{featureType:"road",stylers:[{gamma:2.04},{saturation:28},{hue:"#00b2ff"},{lightness:-42}]},{}],this.options={zoom:21,maxZoom:21,center:ruetaine,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:this.mapStyle},this.mapOptionsURL=this.loadMapOptionsURL()};WorldMapOptions.prototype.loadMapOptionsURL=function(){var a="";for(var b in this.mapStyle){var c=this.mapStyle[b];a+="&style=feature:"+c.featureType,c.elementType!==null&&(a+="|elementType:"+c.elementType);for(var d in c.stylers)for(var e in c.stylers[d]){var f=c.stylers[d][e];typeof f=="string"&&(f=f.replace("#","0x")),a+="|"+e+":"+f}}return a},WorldMapOptions.prototype.getMapImageURL=function(a){var b="http://maps.googleapis.com/maps/api/staticmap?center="+a.lat()+","+a.lng()+"&zoom=21&sensor=false";return b+=this.mapOptionsURL,b},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var CanvasCamera=function(a,b){this.canvas=a,this.canvasMousePosition={x:0,y:0},this.scale=1,this.translate=new Point,this.canvasScaledSize=new Point,this.focusMouseTranslate=new Point,this.mousePosition=new Point,this.drawZoneSize=new Point,this.drawZoneSize.set(b.w,b.h),this.initialTranslate=new Point,this.scaleNum=5,this.mouseInDrawZone=new Point,this.mousePourcentageInDrawZone=new Point,this.scaleFactor=.05,this.scaleMax=5,this.scaledCanvasMousePosition={x:0,y:0},this.mousePourcentagePosition=new Point,this.newMousePosition={x:0,y:0},this.tickCount=0,this.tickStart=0,$(this.canvas).mousedown(function(a){this.mouseISDown=!0,this.saveMouseDown=this.canvasMousePosition}.bind(this)),$(this.canvas).mouseup(function(a){this.mouseISDown=!1}.bind(this)),$(this.canvas).mousemove(function(a){this.mouseMove(a)}.bind(this)),$(this.canvas).bind("mousewheel",function(a,b){return this.mouseMove(a),this.mouseWheel(a,b),!1}.bind(this))};CanvasCamera.prototype.clearContext=function(a){var b=new Point;b.copy(this.canvasScaledSize),b.x<this.canvas.width&&(b.x=this.canvas.width),b.y<this.canvas.height&&(b.y=this.canvas.height),a.clearRect(0,0,b.x,b.y)},CanvasCamera.prototype.debug=function(){var a=[];a.push("canvassize:",this.canvas.width,",",this.canvas.height,"<br/>"),a.push("translate:",this.translate.x,",",this.translate.y,"<br/>"),a.push("mousePosition:",this.mousePosition.toString(),", <br/>"),a.push("canvasmousepos:",this.canvasMousePosition.x,",",this.canvasMousePosition.y,"<br/>"),a.push("mouse%pos:",this.mousePourcentagePosition.x,",",this.mousePourcentagePosition.y,"<br/>"),a.push("scaledmouse%pos:",this.scaledCanvasMousePosition.x,",",this.scaledCanvasMousePosition.y,"<br/>"),a.push("scale:",this.scale,", "+1/this.scale+"<br/>"),a.push("canvasScaledSize:",this.canvasScaledSize.toString(),", <br/>"),a.push("focusMouseTranslate:",this.focusMouseTranslate.toString(),", <br/>"),a.push("mouseInDrawZone:",this.mouseInDrawZone.toString(),", <br/>"),a.push("mouse%InDrawZone:",this.mousePourcentageInDrawZone.toString(),", <br/>"),$("#debugger").html(a.join(""))},CanvasCamera.prototype.close=function(){$(this.canvas).unbind("mousewheel"),$(this.canvas).unbind("mouseup"),$(this.canvas).unbind("mousedown"),$(this.canvas).unbind("mousemove"),$(this.canvas).unbind("click")},CanvasCamera.prototype.focusOnMouseAfterMouseWheel=function(a){var b=new Point;b.set(this.scale*this.canvas.width,this.scale*this.canvas.height);var c=this.mouseInDrawZone.getDivPoint(b),d=new Point;d.copy(c),d.x*=this.canvas.width,d.y*=this.canvas.height;var e=new Point;e.copy(this.mousePourcentagePosition),e.x*=this.canvas.width,e.y*=this.canvas.height,this.focusMouseTranslate.copy(d),this.focusMouseTranslate.sub(e),this.translate.copy(this.focusMouseTranslate),this.translate.inverse(),this.updateMousePositions(a)},CanvasCamera.prototype.mouseWheel=function(a,b){this.mouseMove(a),b>0?setIntervalX(function(){this.scaleUsingFactor(a,-1)}.bind(this),50,this.scaleNum):setIntervalX(function(){this.scaleUsingFactor(a,1)}.bind(this),50,this.scaleNum)},CanvasCamera.prototype.scaleUsingFactor=function(a,b){var c=(this.scaleFactor*b+1)*this.scale;return c>this.scaleMax?(this.scale=this.scaleMax,this.scaleIsMoreThanScaleMax(this)):(this.scale=c,this.focusOnMouseAfterMouseWheel(a),!0)},CanvasCamera.prototype.transform=function(a){a.translate(this.translate.x,this.translate.y),a.scale(1/this.scale,1/this.scale)},CanvasCamera.prototype.updateMousePositions=function(a){this.mousePosition.set(a.pageX-this.canvas.offsetLeft,a.pageY-this.canvas.offsetTop),this.canvasMousePosition=this.mousePosition.getSubPoint(this.translate),this.mousePourcentagePosition.set((this.canvasMousePosition.x+this.translate.x)/this.canvas.width,(this.canvasMousePosition.y+this.translate.y)/this.canvas.height)},CanvasCamera.prototype.mouseMove=function(a){if(a===null)return;this.updateMousePositions(a);var b=new Point;this.mouseISDown&&(b.set(this.canvasMousePosition.x-this.saveMouseDown.x,this.canvasMousePosition.y-this.saveMouseDown.y),this.translate.add(b))},CanvasCamera.prototype.updateScaledSize=function(){this.canvasScaledSize.set(this.canvas.width*this.scale,this.canvas.height*this.scale),this.scale>1&&this.canvasScaledSize.set(this.canvas.width*this.scale,this.canvas.height*this.scale)},CanvasCamera.prototype.update=function(){this.tickCount++;var a=[],b=new Date,c=b.getTime()-this.tickStart;c>1e3&&($("#fps").html("fps:"+this.tickCount),this.tickCount=0,this.tickStart=b.getTime()),this.updateScaledSize(),this.scaledCanvasMousePosition={x:this.canvasMousePosition.x*this.scale,y:this.canvasMousePosition.y*this.scale},this.mouseInDrawZone.copy(this.scaledCanvasMousePosition),this.mouseInDrawZone.x<0&&(this.mouseInDrawZone.x=0),this.mouseInDrawZone.y<0&&(this.mouseInDrawZone.y=0),this.mouseInDrawZone.x>this.drawZoneSize.x&&(this.mouseInDrawZone.x=this.drawZoneSize.x),this.mouseInDrawZone.y>this.drawZoneSize.y&&(this.mouseInDrawZone.y=this.drawZoneSize.y),this.mousePourcentageInDrawZone=this.mouseInDrawZone.getDivPoint(this.drawZoneSize)};var Point=function(){this.x=0,this.y=0};Point.prototype.toString=function(){return"{x:"+this.x+", "+"y:"+this.y+"}"},Point.prototype.copy=function(a){this.x=a.x,this.y=a.y},Point.prototype.inverse=function(){this.x=-1*this.x,this.y=-1*this.y},Point.prototype.div=function(a){this.x/=a,this.y/=a},Point.prototype.getDivPoint=function(a){var b=new Point;return b.set(this.x/a.x,this.y/a.y),b},Point.prototype.multiply=function(a){this.x*=a,this.y*=a},Point.prototype.set=function(a,b){this.x=a,this.y=b},Point.prototype.add=function(a){this.x+=a.x,this.y+=a.y},Point.prototype.sub=function(a){this.x-=a.x,this.y-=a.y},Point.prototype.reset=function(){this.x=0,this.y=0},Point.prototype.getSubPoint=function(a){var b=new Point;return b.set(this.x,this.y),b.sub(a),b},Point.prototype.equals=function(a,b){return Math.abs(a.x-this.x)>b?!1:Math.abs(a.y-this.y)>b?!1:!0},Point.prototype.isInside=function(a,b){return this.x<=a.x?!1:this.y<=a.y?!1:this.x>=a.x+b.w?!1:this.y>=a.y+b.h?!1:!0};var hexcase=0,b64pad="";jQuery.cookie=function(a,b,c){if(arguments.length>1&&String(b)!=="[object Object]"){c=jQuery.extend({},c);if(b===null||b===undefined)c.expires=-1;if(typeof c.expires=="number"){var d=c.expires,e=c.expires=new Date;e.setDate(e.getDate()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=(new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)")).exec(document.cookie))?g(f[1]):null},function(a){function c(b){var c=[].slice.call(arguments,1),d=0,e=!0;return b=a.event.fix(b||window.event),b.type="mousewheel",b.wheelDelta&&(d=b.wheelDelta/120),b.detail&&(d=-b.detail/3),c.unshift(b,d),a.event.handle.apply(this,c)}var b=["DOMMouseScroll","mousewheel"];a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=b.length;a;)this.addEventListener(b[--a],c,!1);else this.onmousewheel=c},teardown:function(){if(this.removeEventListener)for(var a=b.length;a;)this.removeEventListener(b[--a],c,!1);else this.onmousewheel=null}},a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})}(jQuery);var FormValidation=function(a){this.form=$(a),this.rules={}};FormValidation.prototype.addRule=function(a){var b=a.id;typeof this.rules[b]=="undefined"&&(this.rules[b]=[]),this.rules[b].push(a)},FormValidation.prototype.addError=function(a,b){$(a).after('<label class="error"> '+b+"</label>")},FormValidation.prototype.isValid=function(a){this.form.find(".error").remove();var b=!1,c=this.isHTML5Valid();console.log("validate html5 ",c),b=!c||b,this.isRulesValid(function(c){return console.log("validate rules ",c),b=!c||b,a(!b)})},FormValidation.prototype.isRulesValid=function(a){var b=!1;console.log("validate rules ",this.rules);var c=[];_.each(this.rules,function(a){_.each(a,function(a){c.push(a)}.bind(this))}.bind(this));var d=c.length;if(d>0){var e=c[0];return e.doCheck(this,c,0,!1,a)}return a(!b)},FormValidation.prototype.isHTML5InputValid=function(a){var b=a.checkValidity();return b?!0:(this.addError(a,a.validationMessage),!1)},FormValidation.prototype.isHTML5Valid=function(){var a=!1;return this.form.find("input").each(function(b,c){a=!this.isHTML5InputValid(c)||a}.bind(this)),!a},FormValidation.prototype.setOnSubmit=function(a){this.form.bind("submit",a)};var FormRule=function(a,b){this.id=a,this.check=b,this.input=document.getElementById(this.id)};FormRule.prototype.doCheck=function(a,b,c,d,e){var f=b.length,g=$(this.input).val();this.check(g,function(g,h,i){var j=!h;return j&&a.addError(this.input,i),console.log(this.id," is valid ",h," : ",i),c<f-1?b[c+1].doCheck(a,b,c+1,d||j,e):e(!d)}.bind(this))};var imageQueen=new google.maps.MarkerImage("/images/marker-colony.png",new google.maps.Size(35,50),new google.maps.Point(0,0),new google.maps.Point(18,50)),imageQueenShadow=new google.maps.MarkerImage("/images/marker-colony-shadow.png",new google.maps.Size(63,50),new google.maps.Point(0,0),new google.maps.Point(18,50)),shapeQueen={coord:[18,1,19,2,20,3,21,4,22,5,23,6,24,7,25,8,26,9,27,10,28,11,29,12,30,13,31,14,32,15,33,16,32,17,31,18,30,19,29,20,28,21,27,22,26,23,25,24,24,25,23,26,22,27,21,28,20,29,19,30,18,31,18,32,18,33,18,34,18,35,18,36,18,37,18,38,18,39,18,40,18,41,18,42,18,43,18,44,18,45,18,46,18,47,18,48,18,49,17,49,17,48,17,47,17,46,17,45,17,44,17,43,17,42,17,41,17,40,17,39,17,38,17,37,17,36,17,35,17,34,17,33,17,32,17,31,16,30,15,29,14,28,13,27,12,26,11,25,10,24,9,23,8,22,7,21,6,20,5,19,4,18,3,17,2,16,3,15,4,14,5,13,6,12,7,11,8,10,9,9,10,8,11,7,12,6,13,5,14,4,15,3,16,2,17,1,18,1],type:"poly"};ZonesMapType.prototype.maxZoom=21,ZonesMapType.prototype.releaseTile=function(a){},ZonesMapType.prototype.getTile=function(a,b,c){var d=a.x+"_"+a.y,e=c.createElement("DIV");e.style.width=this.tileSize.width+"px",e.style.height=this.tileSize.height+"px",e.id=d,b==21&&(e.style.borderStyle="dotted",e.style.borderWidth="1px",e.style.borderColor="#CCC");if(b==21){var f="",g=(21-b)*2;for(var h=0;h<g*g;++h){var i=this.tileSize.width/g*(h%g),j=this.tileSize.height/g*Math.floor(h/g);f+='<div style="border:1px dotted #F00;width:'+this.tileSize.width/g+";height:"+this.tileSize.height/g+";position:absolute;left:"+i+"px;top:"+j+'px"></div>'}e.innerHTML+=f}return e},$(function(){var a=io.connect(MOA_SERVER);a.on("connect",function(a){console.log("connected to socket io ",a)});var b=new FormValidation("#user-subscribe"),c=new FormRule("nemail",function(b,c){var d=new User(b);d.exists(a,function(a,d){console.log("check user : ",b,"answer",d);var e="No Error.";return d&&(e="The email already exists, please choose a new email."),c(a,!d,e)})}),d=new FormRule("ncpassword",function(a,b){return $("#npassword").val()===$("#ncpassword").val()?b(null,!0,"No Error."):b(null,!1,"Password and confirmation password don't match.")});b.addRule(d),b.addRule(c),b.setOnSubmit(function(b){b.preventDefault(),$("#warn").html("").hide(),$("#info").html("").hide(),this.isValid(function(b){console.log("global validity :",b);if(b){var c=new User($("#nemail").val(),hex_md5($("#npassword").val()));c.subscribe(a)}})}.bind(b)),$("#user-login").submit(function(){var a=hex_md5($("#password").val());$("#password").val(a),$(this)[0].submit()})});var User=function(a,b){this.email=a,this.password=b};User.prototype.subscribe=function(a){a.emit("user-subscribe",this,function(a){if(a){console.error(a.message),$("#warn").append("Impossible to add the user."),$("#error").fadeIn(250);return}$("#info").html("The user has been added, you can now login, your email has been copied into login box."),$("#info").fadeIn(250),$("#email").val(this.email),$("#password").val("")}.bind(this))},User.prototype.exists=function(a,b){a.emit("user-exists",this.email,function(a,c){console.log("get answer",a,c),a&&b(a,!1),c?b(null,!0):b(null,!1)}.bind(this))}